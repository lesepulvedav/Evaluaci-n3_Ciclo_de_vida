name: Parte 1 - Docker CI/CD

# CONFIGURACIÓN AJUSTADA A TUS RAMAS
on:
  push:
    # Se activa cuando haces push a tu rama de trabajo
    branches: [ "lesepulvedav-evaluacion3" ] 
  pull_request:
    # Se activa cuando abres un Pull Request hacia master
    branches: [ "master" ]

jobs:
  docker-cicd:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el código del repositorio
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Login en Docker Hub
      # Asegúrate de haber creado los secrets DOCKER_USERNAME y DOCKER_PASSWORD en GitHub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Construir la imagen Docker (Build)
      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }} .

      # 4. Ejecutar pruebas unitarias DENTRO del contenedor (Requisito de la prueba)
      # Esto asegura que "si las pruebas fallan, no se publique la imagen"
      - name: Run Tests inside Container
        run: docker run --rm ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }} pytest

      # 5. Publicar imagen en Docker Hub
      # El 'if: success()' asegura que solo corra si el paso anterior (tests) funcionó
      - name: Push to Docker Hub
        if: success()
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }}
          # Etiquetamos también como 'latest' para facilitar su uso
          docker tag ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:latest
