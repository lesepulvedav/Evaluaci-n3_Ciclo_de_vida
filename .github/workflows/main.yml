name: CI/CD Completo - Evaluación 3

on:
  push:
    branches: [ "lesepulvedav-evaluacion3" ] # Tu rama de desarrollo
  pull_request:
    branches: [ "master" ] # Tu rama principal (main)

jobs:
  # --- PARTE 2: ANÁLISIS DE SEGURIDAD Y CALIDAD ---
  security-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Necesario para SonarCloud

      # 1. Análisis Estático con Snyk (Requisito: Análisis estático en PR)
      - name: Snyk Security Scan
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          # Falla el pipeline si encuentra vulnerabilidades "High" o "Critical"
          args: --severity-threshold=high

      # 2. Análisis de Calidad con SonarCloud (Requisito: Análisis estático en PR)
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # 3. GitHub Advanced Security (Requisito: Dependencias y Secretos)
      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v3
        # Nota: El escaneo de secretos suele venir activado por defecto en repos públicos

  # --- PARTE 1 + DOCKER SCOUT: CONSTRUCCIÓN Y DESPLIEGUE ---
  build-and-push:
    needs: security-analysis  # ¡CRÍTICO! Esto interrumpe el despliegue si falla la seguridad
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Login en Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Construir imagen Docker
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }} .

      # Pruebas unitarias (Requisito Parte 1)
      - name: Ejecutar pruebas unitarias
        run: docker run --rm ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }} pytest

      # 4. Docker Scout (Requisito: Integrar Docker Scout)
      - name: Docker Scout Analysis
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }}
          only-severities: critical,high
          # exit-code: true # Descomenta esto si quieres que falle también por vulnerabilidades de imagen

      # Publicar en Docker Hub (Solo si todo lo anterior pasó)
      - name: Publicar imagen
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }}
          docker tag ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/tienda-lacteos:latest
